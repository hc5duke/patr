<!--
	Patr - Pats Flickr Extension
    Copyright (C) 2010  Patrick David

	This file is part of Patr.

    Patr is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    Patr is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->

<script>
const API_KEY = "ea1d492fa9803aa760d8039ccb5f73ee";


chrome.extension.onRequest.addListener(
	function( request, sender, sendResponse) {
	if( request.type == "getSizes"){
		sendResponse( getSizes( request.photo_id ) );
	}
        if( request.type == "API" ){
               sendResponse( sendRequest( request.fn, request.params ) );
         }
    if( request.type == "localStorage" ){
        var param = request.param;
        if( typeof param == 'object' ){
            var value = {};
            for( var key in param ){
                value[ param[key] ] = localStorage[ param[key] ];
            }
        }else{
            var value = localStorage[ request.param ];
        }
        sendResponse( value );
    }

});

// Generic Request function
function sendRequest( type, params ){
  var response;
  var req = new XMLHttpRequest();

  var URL = "http://api.flickr.com/services/rest/?" +
            "method=flickr." + type +"&" +
            "format=json&" +
            "nojsoncallback=1&" +
            "api_key=" + API_KEY;

            for( var opt in params ){
               URL += "&" + opt + "=" + params[opt] ;
            }
            console.log( 'params: ');
            console.log( params );

   req.onreadystatechange = function() {
     if( req.readyState == 4 && req.status == 200 ){
         console.log( 'req.responseText: ');
         console.log( req.responseText );
         response = JSON.parse( req.responseText );

     }else{
         response = JSON.parse( req.responseText );
     }
   }
   
   req.open( "GET", URL, false );
   req.send(null);

   return response;
}


function getSizes(photo_id){

	var finalSize;
	var req = new XMLHttpRequest();
	var URL = "http://api.flickr.com/services/rest/?" +
					"method=flickr.photos.getSizes&" +
					"api_key=" + API_KEY + "&" +
					//"photo_id=3797073541";
					//"nojsoncallback=1&" +
					//"format=json&" +
					"photo_id=" + photo_id;

	req.open( "GET", URL, false );
	//req.onload = parseSizes();
	req.onreadystatechange = function() {
		//alert("readyState: " + req.readyState );
		if( req.readyState == 4 ){
			parseSizes();
		}
	}
	req.send(null);

	function parseSizes(){
		finalSize = "dummy-path-to-biggest-sized-image";
		// deal with the list and return the path to the finalSize you want to use...
		var res = req.responseXML.getElementsByTagName("size");
		var sizes = {}
		//alert( typeof( sizes ) );
		sizes.rsp = req.responseXML.getElementsByTagName("rsp")[0].getAttribute("stat");
		for ( var i = 0, sz; sz = res[i]; i++ ){
			sizes[ res[i].getAttribute("label") ] =  {
						"width" : res[i].getAttribute("width"),
						"height": res[i].getAttribute("height"),
						"source": res[i].getAttribute("source")
						} ;
		}
		finalSize = sizes;
	}
	return finalSize;
}

</script>
